name: SwiftLint

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.swift'
      - '.swiftlint.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - '**.swift'
      - '.swiftlint.yml'

jobs:
  swiftlint:
    name: SwiftLint Check
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff

      - name: Install SwiftLint
        run: |
          brew install swiftlint
          swiftlint version

      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging

      - name: Run SwiftLint (Strict Mode for PR)
        if: github.event_name == 'pull_request'
        run: |
          swiftlint lint --strict --reporter github-actions-logging

      - name: Generate SwiftLint Report
        if: always()
        run: |
          swiftlint lint --reporter html > swiftlint-report.html
          swiftlint lint --reporter json > swiftlint-report.json

      - name: Upload SwiftLint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-report
          path: |
            swiftlint-report.html
            swiftlint-report.json
          retention-days: 30

      - name: Comment PR with Violations (if any)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('swiftlint-report.json', 'utf8'));

            if (report.length > 0) {
              let comment = '## ⚠️ SwiftLint Violations Found\n\n';
              comment += `**Total violations:** ${report.length}\n\n`;
              comment += '| File | Line | Rule | Severity | Message |\n';
              comment += '|------|------|------|----------|----------|\n';

              report.slice(0, 20).forEach(violation => {
                const file = violation.file.replace(process.env.GITHUB_WORKSPACE + '/', '');
                const line = violation.line || '-';
                const rule = violation.rule_id || '-';
                const severity = violation.severity || '-';
                const message = violation.reason || '-';
                comment += `| ${file} | ${line} | \`${rule}\` | ${severity} | ${message} |\n`;
              });

              if (report.length > 20) {
                comment += `\n*... and ${report.length - 20} more violations. See full report in artifacts.*\n`;
              }

              comment += '\n---\n';
              comment += '**Action Required:** Please fix these violations before merging.\n';
              comment += 'Run `swiftlint --fix` to auto-correct some issues.\n';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Summary
        if: always()
        run: |
          echo "### SwiftLint Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "✅ No violations found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Violations found. See report for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** .swiftlint.yml" >> $GITHUB_STEP_SUMMARY
