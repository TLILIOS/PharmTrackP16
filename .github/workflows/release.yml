name: Release to TestFlight

on:
  push:
    tags:
      - 'v*.*.*'  # D√©clench√© sur tags semver (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
      build_number:
        description: 'Build number (optional, auto-incremented if not provided)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: false
        type: boolean

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  XCODE_PROJECT: MediStock.xcodeproj
  XCODE_SCHEME: MediStock
  APP_NAME: MediStock

jobs:
  # ============================================
  # JOB 1: Validate Release
  # ============================================
  validate-release:
    name: Validate Release
    runs-on: macos-14
    timeout-minutes: 10

    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version Info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
            BUILD_NUMBER="${{ inputs.build_number }}"
          else
            # Extract from tag (v1.0.0 -> 1.0.0)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          # Auto-increment build number if not provided
          if [ -z "$BUILD_NUMBER" ]; then
            LAST_BUILD=$(git tag -l "v${VERSION}-*" | sort -V | tail -n1 | sed "s/v${VERSION}-//")
            if [ -z "$LAST_BUILD" ]; then
              BUILD_NUMBER=1
            else
              BUILD_NUMBER=$((LAST_BUILD + 1))
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Release Version: $VERSION ($BUILD_NUMBER)"

      - name: Validate Semver
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid semver format: $VERSION"
            exit 1
          fi
          echo "‚úÖ Valid semver: $VERSION"

      - name: Check CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ ! -f CHANGELOG.md ]; then
            echo "‚ö†Ô∏è WARNING: CHANGELOG.md not found"
            exit 0
          fi

          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è WARNING: Version $VERSION not found in CHANGELOG.md"
          else
            echo "‚úÖ CHANGELOG.md contains version $VERSION"
          fi

  # ============================================
  # JOB 2: Run Tests (Optional)
  # ============================================
  test-before-release:
    name: Run Tests Before Release
    runs-on: macos-14
    timeout-minutes: 30
    needs: [validate-release]
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Firebase Mock
        run: |
          mkdir -p MediStock
          cat > MediStock/GoogleService-Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key><string>TEST</string>
            <key>GCM_SENDER_ID</key><string>123</string>
            <key>GOOGLE_APP_ID</key><string>1:123:ios:abc</string>
            <key>PROJECT_ID</key><string>test</string>
          </dict>
          </plist>
          EOF

      - name: Run All Tests
        run: |
          xcodebuild test \
            -project $XCODE_PROJECT \
            -scheme $XCODE_SCHEME \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=17.2' \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

  # ============================================
  # JOB 3: Build & Archive for Release
  # ============================================
  build-and-archive:
    name: Build & Archive Release
    runs-on: macos-14
    timeout-minutes: 45
    needs: [validate-release, test-before-release]
    if: always() && (needs.test-before-release.result == 'success' || needs.test-before-release.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Firebase Production
        run: |
          mkdir -p MediStock
          # Decoder GoogleService-Info.plist depuis GitHub Secrets (base64 encoded)
          if [ -n "${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}" ]; then
            echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}" | base64 --decode > MediStock/GoogleService-Info.plist
            echo "‚úÖ Production GoogleService-Info.plist configured"
          else
            echo "‚ö†Ô∏è WARNING: No production Firebase config. Using placeholder."
            echo '<?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0"><dict>
            <key>API_KEY</key><string>PROD_KEY</string>
            <key>GCM_SENDER_ID</key><string>123456789</string>
            <key>GOOGLE_APP_ID</key><string>1:123456789:ios:prod</string>
            <key>PROJECT_ID</key><string>medistock-e88bb</string>
            </dict></plist>' > MediStock/GoogleService-Info.plist
          fi

      - name: Import Signing Certificate
        if: secrets.IOS_CERTIFICATE_P12
        run: |
          # Cr√©er un keychain temporaire
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Importer le certificat
          echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

          # Cleanup
          rm certificate.p12

      - name: Import Provisioning Profile
        if: secrets.IOS_PROVISIONING_PROFILE
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Update Version and Build Number
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          BUILD_NUMBER="${{ needs.validate-release.outputs.build_number }}"

          # Update Info.plist (adjust path if needed)
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" MediStock/Info.plist || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" MediStock/Info.plist || true

          echo "‚úÖ Updated to version $VERSION ($BUILD_NUMBER)"

      - name: Build & Archive
        run: |
          xcodebuild clean archive \
            -project $XCODE_PROJECT \
            -scheme $XCODE_SCHEME \
            -configuration Release \
            -archivePath build/MediStock.xcarchive \
            CODE_SIGN_STYLE=Automatic \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Export IPA
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/MediStock.xcarchive \
            -exportPath build/Export \
            -exportOptionsPlist ExportOptions.plist \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: medistock-release-${{ needs.validate-release.outputs.version }}
          path: build/Export/*.ipa
          retention-days: 90

      - name: Upload dSYM
        uses: actions/upload-artifact@v4
        with:
          name: medistock-dsym-${{ needs.validate-release.outputs.version }}
          path: build/MediStock.xcarchive/dSYMs
          retention-days: 90

  # ============================================
  # JOB 4: Upload to TestFlight
  # ============================================
  upload-testflight:
    name: Upload to TestFlight
    runs-on: macos-14
    timeout-minutes: 30
    needs: [validate-release, build-and-archive]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download IPA
        uses: actions/download-artifact@v4
        with:
          name: medistock-release-${{ needs.validate-release.outputs.version }}
          path: build/Export

      - name: Upload to TestFlight (using Fastlane)
        if: secrets.APP_STORE_CONNECT_API_KEY
        run: |
          # Configuration Fastlane (voir Fastfile)
          # fastlane beta

          echo "‚ö†Ô∏è TestFlight upload skipped (Fastlane not configured)"
          echo "Configure Fastlane and App Store Connect API Key to enable auto-upload"

      - name: Upload to TestFlight (using altool)
        if: secrets.APPLE_ID && secrets.APP_SPECIFIC_PASSWORD
        continue-on-error: true
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file build/Export/*.ipa \
            --username "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APP_SPECIFIC_PASSWORD }}" \
            --verbose

  # ============================================
  # JOB 5: Create GitHub Release
  # ============================================
  create-github-release:
    name: Create GitHub Release
    runs-on: macos-14
    needs: [validate-release, build-and-archive, upload-testflight]
    if: always() && needs.build-and-archive.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download IPA
        uses: actions/download-artifact@v4
        with:
          name: medistock-release-${{ needs.validate-release.outputs.version }}
          path: release-artifacts

      - name: Extract Release Notes
        id: notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          if [ -f CHANGELOG.md ]; then
            # Extract notes for this version from CHANGELOG
            NOTES=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
          else
            NOTES="Release version $VERSION"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          name: MediStock v${{ needs.validate-release.outputs.version }}
          body: |
            ## üéâ MediStock v${{ needs.validate-release.outputs.version }}

            **Build:** ${{ needs.validate-release.outputs.build_number }}
            **Date:** ${{ github.event.head_commit.timestamp }}

            ### Release Notes
            ${{ steps.notes.outputs.notes }}

            ### Installation
            - Download IPA from assets below
            - Upload to TestFlight is automatic
            - Production release requires manual App Store submission

            ### Artifacts
            - `MediStock.ipa` - Signed application bundle
            - `dSYMs.zip` - Debug symbols for crash reporting

            ---
            **Auteur:** TLILI HAMDI
            **Generated by:** GitHub Actions Release Pipeline
          files: |
            release-artifacts/*.ipa
          draft: false
          prerelease: false

  # ============================================
  # JOB 6: Notification & Cleanup
  # ============================================
  notify-release:
    name: Release Notification
    runs-on: macos-14
    needs: [validate-release, create-github-release, upload-testflight]
    if: always()

    steps:
      - name: Generate Release Summary
        run: |
          echo "### üöÄ Release Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.validate-release.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Archive | ${{ needs.build-and-archive.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TestFlight Upload | ${{ needs.upload-testflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-github-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.create-github-release.result }}" == "success" ]; then
            echo "‚úÖ **Release created successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check TestFlight for build availability" >> $GITHUB_STEP_SUMMARY
            echo "2. Add beta testers in App Store Connect" >> $GITHUB_STEP_SUMMARY
            echo "3. Submit for App Store review when ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Release pipeline failed. Please investigate.**" >> $GITHUB_STEP_SUMMARY
          fi

      # Optionnel: Notification Slack
      # - name: Slack Notification
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     webhook-url: ${{ secrets.SLACK_WEBHOOK }}
      #     payload: |
      #       {
      #         "text": "üöÄ MediStock v${{ needs.validate-release.outputs.version }} released to TestFlight!"
      #       }
