name: PR Validation

on:
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  XCODE_PROJECT: MediStock.xcodeproj
  XCODE_SCHEME: MediStock
  SIMULATOR_DEVICE: iPhone 16
  SIMULATOR_OS: iOS 17.2

jobs:
  # ============================================
  # JOB 1: Validation Rapide (Fast Checks)
  # ============================================
  fast-checks:
    name: Fast Checks
    runs-on: macos-14
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files
        run: |
          if find . -name "GoogleService-Info.plist" -not -path "./.git/*" | grep -q .; then
            echo "‚ùå ERROR: GoogleService-Info.plist found in repository!"
            exit 1
          fi
          if find . -name "*.key" -o -name "*.p12" | grep -q .; then
            echo "‚ùå ERROR: Key files found in repository!"
            exit 1
          fi
          echo "‚úÖ No sensitive files detected"

      - name: Check Swift version
        run: |
          swift --version
          xcodebuild -version

      - name: Validate Xcode project
        run: |
          xcodebuild -list -project $XCODE_PROJECT
          xcodebuild -showBuildSettings -project $XCODE_PROJECT -scheme $XCODE_SCHEME | head -n 20

  # ============================================
  # JOB 2: SwiftLint
  # ============================================
  swiftlint:
    name: SwiftLint Check
    runs-on: macos-14
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: |
          brew install swiftlint
          swiftlint version

      - name: Run SwiftLint (Strict)
        run: |
          swiftlint lint --strict --reporter github-actions-logging

      - name: Generate SwiftLint Report
        if: always()
        run: |
          swiftlint lint --reporter html > swiftlint-report.html || true
          swiftlint lint --reporter json > swiftlint-report.json || true

      - name: Upload SwiftLint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-report
          path: |
            swiftlint-report.html
            swiftlint-report.json
          retention-days: 14

  # ============================================
  # JOB 3: Build & Unit Tests
  # ============================================
  build-and-test:
    name: Build & Unit Tests
    runs-on: macos-14
    timeout-minutes: 30
    needs: [fast-checks]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Firebase Mock
        run: |
          # Cr√©er un GoogleService-Info.plist fictif pour les tests
          mkdir -p MediStock
          cat > MediStock/GoogleService-Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key>
            <string>TEST_API_KEY</string>
            <key>GCM_SENDER_ID</key>
            <string>123456789</string>
            <key>GOOGLE_APP_ID</key>
            <string>1:123456789:ios:abcdef</string>
            <key>PROJECT_ID</key>
            <string>test-project</string>
          </dict>
          </plist>
          EOF

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer || true
          xcodebuild -version

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve Swift Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies -project $XCODE_PROJECT -scheme $XCODE_SCHEME

      - name: Build Project
        run: |
          xcodebuild clean build \
            -project $XCODE_PROJECT \
            -scheme $XCODE_SCHEME \
            -destination "platform=iOS Simulator,name=$SIMULATOR_DEVICE,OS=$SIMULATOR_OS" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Run Unit Tests
        run: |
          xcodebuild test \
            -project $XCODE_PROJECT \
            -scheme $XCODE_SCHEME \
            -destination "platform=iOS Simulator,name=$SIMULATOR_DEVICE,OS=$SIMULATOR_OS" \
            -configuration Debug \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 14

      - name: Generate Code Coverage Report
        if: always()
        run: |
          xcrun xccov view --report --json TestResults.xcresult > coverage.json || true
          xcrun xccov view --report TestResults.xcresult > coverage.txt || true

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.json
            coverage.txt
          retention-days: 14

      - name: Check Coverage Threshold
        if: always()
        run: |
          COVERAGE=$(xcrun xccov view --report --json TestResults.xcresult | jq '.targets[] | select(.name=="MediStock") | .lineCoverage' || echo "0")
          echo "Code Coverage: $COVERAGE%"
          THRESHOLD=80
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "‚ö†Ô∏è WARNING: Code coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
            # Ne pas bloquer le PR, juste avertir
          else
            echo "‚úÖ Code coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
          fi

  # ============================================
  # JOB 4: Build Performance
  # ============================================
  build-performance:
    name: Build Performance Check
    runs-on: macos-14
    timeout-minutes: 20
    needs: [fast-checks]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Firebase Mock
        run: |
          mkdir -p MediStock
          cat > MediStock/GoogleService-Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key><string>TEST</string>
            <key>GCM_SENDER_ID</key><string>123</string>
            <key>GOOGLE_APP_ID</key><string>1:123:ios:abc</string>
            <key>PROJECT_ID</key><string>test</string>
          </dict>
          </plist>
          EOF

      - name: Measure Build Time
        run: |
          START_TIME=$(date +%s)
          xcodebuild clean build \
            -project $XCODE_PROJECT \
            -scheme $XCODE_SCHEME \
            -destination "platform=iOS Simulator,name=$SIMULATOR_DEVICE,OS=$SIMULATOR_OS" \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=YES \
            | xcpretty
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          echo "Build time: ${BUILD_TIME}s"
          echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV

      - name: Comment PR with Build Time
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const buildTime = process.env.BUILD_TIME;
            const comment = `## ‚è±Ô∏è Build Performance\n\n**Build Time:** ${buildTime}s\n\n` +
              (buildTime > 300 ? '‚ö†Ô∏è Build time exceeds 5 minutes' : '‚úÖ Build time is acceptable');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # JOB 5: Summary
  # ============================================
  pr-summary:
    name: PR Summary
    runs-on: macos-14
    needs: [swiftlint, build-and-test, build-performance]
    if: always()

    steps:
      - name: Generate Summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'SwiftLint', status: '${{ needs.swiftlint.result }}' },
              { name: 'Build & Tests', status: '${{ needs.build-and-test.result }}' },
              { name: 'Build Performance', status: '${{ needs.build-performance.result }}' }
            ];

            let summary = '## üìä PR Validation Summary\n\n';
            summary += '| Check | Status |\n';
            summary += '|-------|--------|\n';

            jobs.forEach(job => {
              const emoji = job.status === 'success' ? '‚úÖ' : '‚ùå';
              summary += `| ${job.name} | ${emoji} ${job.status} |\n`;
            });

            summary += '\n---\n';
            const allPassed = jobs.every(job => job.status === 'success');
            if (allPassed) {
              summary += '‚úÖ **All checks passed! PR is ready for review.**';
            } else {
              summary += '‚ùå **Some checks failed. Please fix the issues before merging.**';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
