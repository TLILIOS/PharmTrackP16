name: iOS Build and Test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.4.app

    - name: Build and Test
      run: |
        echo "# Xcode test results" >> $GITHUB_STEP_SUMMARY
        echo "## Testing project MediStock with scheme MediStock" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        xcodebuild clean test \
          -project MediStock.xcodeproj \
          -scheme MediStock \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
          -resultBundlePath TestResults/TestResults.xcresult \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --test --color || exit 1

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults/TestResults.xcresult
      if: always()
    
    - name: Test Summary
      if: always()
      run: |
        echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -d "TestResults/TestResults.xcresult" ]; then
          echo "âœ… Tests completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test results have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No test results found" >> $GITHUB_STEP_SUMMARY
        fi

  deploy:
    name: Deploy to TestFlight
    runs-on: macos-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.4.app

    - name: Build for Release
      run: |
        echo "# ðŸš€ Release Build" >> $GITHUB_STEP_SUMMARY
        echo "## Building MediStock for release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        xcodebuild clean build \
          -project MediStock.xcodeproj \
          -scheme MediStock \
          -configuration Release \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color || exit 1

    - name: Release Summary
      run: |
        echo "### âœ… Release build completed" >> $GITHUB_STEP_SUMMARY
        echo "Ready for manual deployment to TestFlight/App Store" >> $GITHUB_STEP_SUMMARY
