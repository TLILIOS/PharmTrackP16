name: iOS Build and Test

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: xcrun simctl list devices available

    - name: Setup Firebase Configuration
      if: env.GOOGLE_SERVICE_INFO_PLIST != ''
      env:
        GOOGLE_SERVICE_INFO_PLIST: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
      run: |
        if [ -n "$GOOGLE_SERVICE_INFO_PLIST" ]; then
          echo "ðŸ“± Setting up Firebase configuration..."
          echo "$GOOGLE_SERVICE_INFO_PLIST" | base64 --decode > MediStock/GoogleService-Info.plist
          echo "âœ… GoogleService-Info.plist configured"
        else
          echo "âš ï¸ GOOGLE_SERVICE_INFO_PLIST not configured, using existing file"
        fi

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Resolving Swift Package dependencies..."
        xcodebuild -resolvePackageDependencies -scheme MediStock -project MediStock.xcodeproj

    - name: Build for Testing
      run: |
        echo "ðŸ”¨ Building for testing..."
        xcodebuild build-for-testing \
          -project MediStock.xcodeproj \
          -scheme MediStock \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          -derivedDataPath DerivedData \
          | xcpretty || true

    - name: Run Tests
      run: |
        echo "ðŸ§ª Running tests..."
        xcodebuild test-without-building \
          -project MediStock.xcodeproj \
          -scheme MediStock \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          -derivedDataPath DerivedData \
          -resultBundlePath TestResults/TestResults.xcresult \
          | xcpretty || true
      continue-on-error: true

    - name: Check if test results exist
      id: check_results
      run: |
        if [ -d "TestResults/TestResults.xcresult" ]; then
          echo "results_exist=true" >> $GITHUB_OUTPUT
          echo "âœ… Test results found"
        else
          echo "results_exist=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Test results not found"
        fi

    - name: Process Test Results
      if: steps.check_results.outputs.results_exist == 'true'
      uses: kishikawakatsumi/xcresulttool@v1
      with:
        path: TestResults/TestResults.xcresult
      continue-on-error: true

    - name: Upload Test Results
      if: always() && steps.check_results.outputs.results_exist == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: TestResults/TestResults.xcresult
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -d "TestResults/TestResults.xcresult" ]; then
          echo "âœ… Tests executed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Tests were not executed or failed" >> $GITHUB_STEP_SUMMARY
        fi
