# Fastfile - MediStock
# Auteur: TLILI HAMDI
# Documentation: https://docs.fastlane.tools

# ============================================
# Configuration
# ============================================

default_platform(:ios)

platform :ios do
  # Variables globales
  APP_NAME = "MediStock"
  XCODE_PROJECT = "MediStock.xcodeproj"
  XCODE_SCHEME = "MediStock"
  BUNDLE_ID = "com.tlilihamdi.medistock"  # Ajuster selon votre bundle ID

  # ============================================
  # LANE: Tests
  # ============================================

  desc "Run all tests"
  lane :test do
    run_tests(
      project: XCODE_PROJECT,
      scheme: XCODE_SCHEME,
      devices: ["iPhone 16"],
      clean: true,
      code_coverage: true,
      output_directory: "./fastlane/test_output",
      result_bundle: true
    )
  end

  desc "Run tests and generate coverage report"
  lane :test_with_coverage do
    test

    # G√©n√©rer rapport de couverture
    xcov(
      project: XCODE_PROJECT,
      scheme: XCODE_SCHEME,
      output_directory: "./fastlane/coverage",
      minimum_coverage_percentage: 80.0,
      ignore_file_path: "./fastlane/.xcovignore"
    )
  end

  # ============================================
  # LANE: Build
  # ============================================

  desc "Build the app for development"
  lane :build_dev do
    build_app(
      project: XCODE_PROJECT,
      scheme: XCODE_SCHEME,
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build",
      clean: true
    )
  end

  desc "Build the app for release"
  lane :build_release do
    # Increment build number
    increment_build_number(xcodeproj: XCODE_PROJECT)

    build_app(
      project: XCODE_PROJECT,
      scheme: XCODE_SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      clean: true,
      export_options: {
        provisioningProfiles: {
          BUNDLE_ID => "match AppStore #{BUNDLE_ID}"
        }
      }
    )
  end

  # ============================================
  # LANE: Beta (TestFlight)
  # ============================================

  desc "Upload a new build to TestFlight"
  lane :beta do
    # 1. V√©rifications pr√©liminaires
    ensure_git_status_clean

    # 2. Incr√©menter build number
    increment_build_number(xcodeproj: XCODE_PROJECT)

    # 3. Run tests
    UI.message("üß™ Running tests before build...")
    test

    # 4. Build
    UI.message("üî® Building release version...")
    build_app(
      project: XCODE_PROJECT,
      scheme: XCODE_SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      clean: true
    )

    # 5. Upload to TestFlight
    UI.message("üì§ Uploading to TestFlight...")
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,  # Distribution manuelle aux testeurs externes
      notify_external_testers: false,
      changelog: "New beta build from Fastlane"
    )

    # 6. Commit version bump
    commit_version_bump(
      message: "chore: Bump build number for TestFlight release",
      xcodeproj: XCODE_PROJECT
    )

    # 7. Tag release
    add_git_tag(
      tag: "beta/#{get_build_number(xcodeproj: XCODE_PROJECT)}"
    )

    # 8. Push to remote
    push_to_git_remote

    UI.success("‚úÖ Successfully uploaded build to TestFlight!")
  end

  desc "Upload to TestFlight with external testers"
  lane :beta_external do
    beta

    # Distribuer aux testeurs externes
    upload_to_testflight(
      distribute_external: true,
      notify_external_testers: true,
      groups: ["Beta Testers"],
      changelog: "Nouvelle version beta disponible!"
    )
  end

  # ============================================
  # LANE: Release (App Store)
  # ============================================

  desc "Deploy a new version to the App Store"
  lane :release do
    # 1. V√©rifications
    ensure_git_status_clean
    ensure_git_branch(branch: "main")

    # 2. Prompt for version number
    version = UI.input("Enter version number (e.g., 1.0.0): ")
    increment_version_number(
      version_number: version,
      xcodeproj: XCODE_PROJECT
    )

    # 3. Tests complets
    UI.message("üß™ Running full test suite...")
    test

    # 4. Build
    UI.message("üî® Building for App Store...")
    build_release

    # 5. Capture screenshots (optionnel)
    # capture_screenshots

    # 6. Upload to App Store Connect
    UI.message("üì§ Uploading to App Store Connect...")
    upload_to_app_store(
      submit_for_review: false,  # Soumission manuelle recommand√©e
      automatic_release: false,
      force: true,
      skip_metadata: false,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )

    # 7. Commit version bump
    commit_version_bump(
      message: "chore: Release version #{version}",
      xcodeproj: XCODE_PROJECT
    )

    # 8. Tag release
    add_git_tag(tag: "v#{version}")

    # 9. Push
    push_to_git_remote(tags: true)

    # 10. Create GitHub release
    github_release = set_github_release(
      repository_name: "YOUR_USERNAME/MediStock",
      api_token: ENV["GITHUB_TOKEN"],
      name: "v#{version}",
      tag_name: "v#{version}",
      description: File.read("../CHANGELOG.md") rescue "Release v#{version}",
      commitish: "main"
    )

    UI.success("‚úÖ Successfully released version #{version} to App Store!")
  end

  # ============================================
  # LANE: Screenshots
  # ============================================

  desc "Generate screenshots for App Store"
  lane :screenshots do
    capture_screenshots(
      scheme: XCODE_SCHEME,
      devices: [
        "iPhone 16 Pro Max",
        "iPhone 16 Pro",
        "iPhone 16",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      languages: ["fr-FR", "en-US"],
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: true
    )

    # Optionnel: framer les screenshots
    frame_screenshots(
      white: false,
      path: "./fastlane/screenshots"
    )
  end

  # ============================================
  # LANE: Code Signing (Match)
  # ============================================

  desc "Sync code signing certificates and profiles (Development)"
  lane :sync_certificates_dev do
    match(
      type: "development",
      app_identifier: BUNDLE_ID,
      readonly: is_ci
    )
  end

  desc "Sync code signing certificates and profiles (App Store)"
  lane :sync_certificates_appstore do
    match(
      type: "appstore",
      app_identifier: BUNDLE_ID,
      readonly: is_ci
    )
  end

  # ============================================
  # LANE: Utilities
  # ============================================

  desc "Increment version number (patch)"
  lane :bump_patch do
    increment_version_number(
      bump_type: "patch",
      xcodeproj: XCODE_PROJECT
    )
    commit_version_bump(
      message: "chore: Bump patch version",
      xcodeproj: XCODE_PROJECT
    )
  end

  desc "Increment version number (minor)"
  lane :bump_minor do
    increment_version_number(
      bump_type: "minor",
      xcodeproj: XCODE_PROJECT
    )
    commit_version_bump(
      message: "chore: Bump minor version",
      xcodeproj: XCODE_PROJECT
    )
  end

  desc "Increment version number (major)"
  lane :bump_major do
    increment_version_number(
      bump_type: "major",
      xcodeproj: XCODE_PROJECT
    )
    commit_version_bump(
      message: "chore: Bump major version",
      xcodeproj: XCODE_PROJECT
    )
  end

  desc "Clean build artifacts"
  lane :clean do
    clear_derived_data
    clean_build_artifacts
    UI.success("‚úÖ Cleaned all build artifacts")
  end

  desc "Run SwiftLint"
  lane :lint do
    swiftlint(
      mode: :lint,
      executable: "swiftlint",
      config_file: ".swiftlint.yml",
      strict: true,
      raise_if_swiftlint_error: true
    )
  end

  desc "Auto-fix SwiftLint violations"
  lane :lint_fix do
    swiftlint(
      mode: :fix,
      executable: "swiftlint",
      config_file: ".swiftlint.yml"
    )
  end

  # ============================================
  # LANE: CI/CD
  # ============================================

  desc "CI: Run all checks (lint, tests, build)"
  lane :ci do
    UI.message("üöÄ Running CI pipeline...")

    # 1. Lint
    UI.message("1/3 Running SwiftLint...")
    lint

    # 2. Tests
    UI.message("2/3 Running tests...")
    test

    # 3. Build
    UI.message("3/3 Building...")
    build_dev

    UI.success("‚úÖ CI pipeline completed successfully!")
  end

  desc "CD: Deploy to TestFlight (from CI)"
  lane :cd_beta do
    UI.message("üöÄ Running CD pipeline for TestFlight...")

    # Setup CI environment
    setup_ci if is_ci

    # Sync certificates
    sync_certificates_appstore

    # Deploy
    beta

    UI.success("‚úÖ CD pipeline completed successfully!")
  end

  # ============================================
  # After/Error Handlers
  # ============================================

  after_all do |lane|
    # Notification de succ√®s (optionnel)
    # slack(
    #   message: "Successfully executed lane #{lane} üöÄ",
    #   success: true
    # )
  end

  error do |lane, exception|
    # Notification d'erreur (optionnel)
    # slack(
    #   message: "Error in lane #{lane}: #{exception.message}",
    #   success: false
    # )

    UI.error("‚ùå Error in lane #{lane}: #{exception.message}")
  end

end

# ============================================
# Documentation des Commandes
# ============================================

# Installation:
# $ brew install fastlane
# $ fastlane init

# Commandes principales:
# $ fastlane test                  # Run tests
# $ fastlane build_dev            # Build development
# $ fastlane build_release        # Build release
# $ fastlane beta                 # Upload to TestFlight
# $ fastlane release              # Deploy to App Store
# $ fastlane screenshots          # Generate screenshots
# $ fastlane lint                 # Run SwiftLint
# $ fastlane ci                   # Run CI pipeline
# $ fastlane cd_beta              # CD pipeline (CI environment)

# Configuration requise:
# - App Store Connect API Key (pour upload automatique)
# - Match repository (pour code signing)
# - GitHub token (pour releases automatiques)

# Variables d'environnement:
# FASTLANE_USER              - Apple ID
# FASTLANE_PASSWORD          - App-specific password
# FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD
# APP_STORE_CONNECT_API_KEY_KEY_ID
# APP_STORE_CONNECT_API_KEY_ISSUER_ID
# APP_STORE_CONNECT_API_KEY_KEY
# MATCH_PASSWORD             - Match encryption password
# GITHUB_TOKEN               - GitHub personal access token
