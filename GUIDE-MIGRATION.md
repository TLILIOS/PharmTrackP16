# Guide de Migration - Architecture Testable avec Mocks

## üéØ Objectif

Migrer le projet MediStock d'une architecture coupl√©e √† Firebase vers une architecture MVVM testable avec injection de d√©pendances et mocks.

---

## ‚è±Ô∏è Temps Estim√©

- **Total**: 2-3 jours
- **√âtape 1-3**: 4 heures
- **√âtape 4-5**: 1 jour
- **√âtape 6-7**: 1 jour
- **Tests**: 4 heures

---

## üìã Checklist de Migration

### Phase 1: Pr√©paration (1 heure)

- [ ] Lire la documentation compl√®te (`SOLUTION-APIS-FIREBASE.md`)
- [ ] Cr√©er une branche Git: `git checkout -b feature/testable-architecture`
- [ ] Faire un backup du projet actuel
- [ ] Cr√©er un projet Firebase de test s√©par√©

### Phase 2: Configuration S√©curit√© (1 heure)

- [ ] Ajouter les fichiers de config au `.gitignore` ‚úÖ (D√©j√† fait)
- [ ] Cr√©er les variables d'environnement dans Xcode
- [ ] Configurer les schemes (Debug/Release/Test)
- [ ] Tester le chargement de configuration

### Phase 3: Cr√©ation des Protocoles (30 minutes)

- [ ] Ajouter `AuthServiceProtocol.swift` au projet ‚úÖ (D√©j√† cr√©√©)
- [ ] Ajouter `DataServiceProtocol.swift` au projet ‚úÖ (D√©j√† cr√©√©)
- [ ] Compiler pour v√©rifier les erreurs

### Phase 4: Migration des Services (2 heures)

- [ ] Renommer `AuthService` ‚Üí `FirebaseAuthService`
- [ ] Impl√©menter `AuthServiceProtocol` dans `FirebaseAuthService`
- [ ] Renommer `DataService` ‚Üí `FirebaseDataService`
- [ ] Impl√©menter `DataServiceProtocol` dans `FirebaseDataService`
- [ ] Cr√©er des typealias pour r√©trocompatibilit√©

### Phase 5: Cr√©ation des Mocks (30 minutes)

- [ ] Ajouter `MockAuthService.swift` aux tests ‚úÖ (D√©j√† cr√©√©)
- [ ] Ajouter `MockDataService.swift` aux tests ‚úÖ (D√©j√† cr√©√©)
- [ ] Compiler les tests pour v√©rifier

### Phase 6: Migration des ViewModels (1 jour)

Pour **chaque ViewModel**:

- [ ] `AuthViewModel`
  - [ ] Ajouter propri√©t√© `authService: AuthServiceProtocol`
  - [ ] Ajouter initializer avec injection
  - [ ] Remplacer appels directs par appels via protocole
  - [ ] Cr√©er tests unitaires avec mock

- [ ] `MedicineListViewModel`
  - [ ] Ajouter propri√©t√© `dataService: DataServiceProtocol`
  - [ ] Ajouter initializer avec injection
  - [ ] Remplacer appels directs par appels via protocole
  - [ ] Cr√©er tests unitaires avec mock

- [ ] `AisleListViewModel`
  - [ ] Ajouter propri√©t√© `dataService: DataServiceProtocol`
  - [ ] Ajouter initializer avec injection
  - [ ] Remplacer appels directs par appels via protocole
  - [ ] Cr√©er tests unitaires avec mock

- [ ] `HistoryViewModel`
  - [ ] Ajouter propri√©t√© `dataService: DataServiceProtocol`
  - [ ] Ajouter initializer avec injection
  - [ ] Remplacer appels directs par appels via protocole
  - [ ] Cr√©er tests unitaires avec mock

### Phase 7: Migration des Tests (1 jour)

- [ ] Supprimer les tests d'int√©gration Firebase (ou les marquer comme optionnels)
- [ ] Cr√©er tests unitaires pour tous les ViewModels
- [ ] Cr√©er tests unitaires pour les Repositories
- [ ] V√©rifier la couverture de code (objectif: >80%)

### Phase 8: Configuration Firebase (1 heure)

- [ ] Int√©grer `FirebaseConfigLoader.swift` ‚úÖ (D√©j√† cr√©√©)
- [ ] Mettre √† jour `@main App` pour utiliser le config manager
- [ ] Tester en Debug (mocks)
- [ ] Tester en Release (Firebase r√©el)

### Phase 9: Validation (2 heures)

- [ ] Ex√©cuter tous les tests unitaires (doivent passer √† 100%)
- [ ] Tester l'app en mode Debug
- [ ] Tester l'app en mode Release
- [ ] V√©rifier les performances
- [ ] Code review

### Phase 10: D√©ploiement (30 minutes)

- [ ] Cr√©er une Pull Request
- [ ] Documenter les changements
- [ ] Merger dans main apr√®s validation
- [ ] Cr√©er un tag de version

---

## üîß Instructions D√©taill√©es

### √âtape 1: Configuration des Variables d'Environnement

**Dans Xcode**:

1. Product ‚Üí Scheme ‚Üí Edit Scheme
2. Run ‚Üí Arguments ‚Üí Environment Variables
3. Ajouter:

```
FIREBASE_API_KEY_PROD = [Votre cl√© production]
FIREBASE_API_KEY_TEST = [Votre cl√© test]
```

4. R√©p√©ter pour Test et Release schemes

### √âtape 2: Migration d'un Service

**Avant** (`AuthService.swift`):

```swift
import FirebaseAuth

@MainActor
class AuthService: ObservableObject {
    @Published var currentUser: User?

    func signIn(email: String, password: String) async throws {
        // Impl√©mentation Firebase
    }
}
```

**Apr√®s** (`FirebaseAuthService.swift`):

```swift
import FirebaseAuth

@MainActor
class FirebaseAuthService: AuthServiceProtocol {
    @Published var currentUser: User?

    // Garder la m√™me impl√©mentation
    func signIn(email: String, password: String) async throws {
        // M√™me code qu'avant
    }
}

// R√©trocompatibilit√©
typealias AuthService = FirebaseAuthService
```

### √âtape 3: Migration d'un ViewModel

**Avant**:

```swift
@Observable
class MedicineListViewModel {
    var medicines: [Medicine] = []
    private let dataService = DataService()

    func loadMedicines() async throws {
        medicines = try await dataService.getMedicines()
    }
}
```

**Apr√®s**:

```swift
@Observable
class MedicineListViewModel {
    var medicines: [Medicine] = []
    private let dataService: DataServiceProtocol

    // Injection de d√©pendances avec valeur par d√©faut
    init(dataService: DataServiceProtocol = FirebaseDataService()) {
        self.dataService = dataService
    }

    func loadMedicines() async throws {
        medicines = try await dataService.getMedicines()
    }
}
```

### √âtape 4: Cr√©ation d'un Test Unitaire

**Nouveau fichier**: `MedicineListViewModelTests.swift`

```swift
import XCTest
@testable import MediStock

@MainActor
final class MedicineListViewModelTests: XCTestCase {
    var viewModel: MedicineListViewModel!
    var mockDataService: MockDataService!

    override func setUp() {
        super.setUp()
        mockDataService = MockDataService()
        mockDataService.seedTestData()
        viewModel = MedicineListViewModel(dataService: mockDataService)
    }

    override func tearDown() {
        viewModel = nil
        mockDataService = nil
        super.tearDown()
    }

    func testLoadMedicinesSuccess() async throws {
        // When
        try await viewModel.loadMedicines()

        // Then
        XCTAssertEqual(viewModel.medicines.count, 1)
        XCTAssertEqual(mockDataService.getMedicinesCallCount, 1)
    }
}
```

### √âtape 5: Configuration de l'App

**Mettre √† jour** `MediStockApp.swift`:

```swift
import SwiftUI
import FirebaseCore

@main
struct MediStockApp: App {

    init() {
        configureFirebase()
    }

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(createAuthService())
        }
    }

    private func configureFirebase() {
        #if DEBUG
        // En mode Debug, utiliser les mocks ou l'√©mulateur
        FirebaseConfigManager.shared.configureForTesting()
        #else
        // En mode Release, utiliser Firebase production
        FirebaseConfigManager.shared.configure(for: .production)
        #endif
    }

    private func createAuthService() -> FirebaseAuthService {
        return FirebaseAuthService()
    }
}
```

---

## üß™ Validation des Tests

### Commandes Terminal

```bash
# Ex√©cuter tous les tests
xcodebuild test -scheme MediStock -destination 'platform=iOS Simulator,name=iPhone 15'

# Mesurer la couverture de code
xcodebuild test -scheme MediStock -enableCodeCoverage YES

# Tests uniquement (rapide)
xcodebuild test -scheme MediStockTests -destination 'platform=iOS Simulator,name=iPhone 15'
```

### V√©rifier la Couverture

1. Product ‚Üí Test (‚åòU)
2. Report Navigator (‚åò9)
3. Coverage tab
4. V√©rifier: ViewModels > 80%, Repositories > 80%

---

## ‚ö†Ô∏è Points d'Attention

### Erreurs Courantes

#### 1. "Cannot find 'AuthServiceProtocol' in scope"

**Solution**: V√©rifier que les protocoles sont dans le target principal

#### 2. "Type 'FirebaseAuthService' does not conform to protocol 'AuthServiceProtocol'"

**Solution**: Impl√©menter toutes les m√©thodes du protocole

#### 3. Tests qui √©chouent avec "Firebase not configured"

**Solution**: Utiliser les mocks dans les tests, pas FirebaseService

#### 4. "Ambiguous use of 'authService'"

**Solution**: Sp√©cifier le type explicitement

```swift
private let authService: AuthServiceProtocol
```

### Bonnes Pratiques

‚úÖ **Faire** un commit apr√®s chaque √©tape valid√©e
‚úÖ **Tester** fr√©quemment pendant la migration
‚úÖ **Documenter** les changements non √©vidents
‚úÖ **Demander** un code review avant le merge

‚ùå **Ne pas** tout migrer d'un coup
‚ùå **Ne pas** skipper les tests
‚ùå **Ne pas** committer les API keys
‚ùå **Ne pas** casser la compatibilit√© existante

---

## üöÄ Apr√®s la Migration

### Tests de Non-R√©gression

1. [ ] Tester toutes les fonctionnalit√©s principales
2. [ ] V√©rifier l'authentification (sign in/out)
3. [ ] V√©rifier CRUD m√©dicaments
4. [ ] V√©rifier CRUD rayons
5. [ ] V√©rifier historique
6. [ ] Tester sur device r√©el
7. [ ] Tester en mode offline

### Optimisations Futures

- [ ] Configurer Firebase Emulators pour dev local
- [ ] Ajouter retry logic pour erreurs r√©seau
- [ ] Impl√©menter cache local
- [ ] Ajouter analytics pour suivre les erreurs
- [ ] Configurer CI/CD pour tests automatiques

---

## üìû Aide & Support

### Ressources

- Documentation compl√®te: `SOLUTION-APIS-FIREBASE.md`
- Exemples de tests: `ExampleMigratedViewModelTest.swift`
- Mocks: `MediStockTests/Mocks/`

### Questions Fr√©quentes

**Q: Dois-je supprimer les anciens tests d'int√©gration Firebase?**
R: Non, vous pouvez les garder mais les marquer comme optionnels ou les d√©placer dans un groupe s√©par√©.

**Q: Comment tester avec Firebase r√©el occasionnellement?**
R: Cr√©er un scheme "Integration" qui utilise FirebaseService au lieu des mocks.

**Q: Que faire si un test √©choue apr√®s migration?**
R: V√©rifier que vous utilisez bien le mock et pas le service r√©el.

**Q: Faut-il migrer tous les ViewModels en m√™me temps?**
R: Non, migrez-les un par un et testez apr√®s chaque migration.

---

## ‚úÖ Validation Finale

Avant de marquer la migration comme termin√©e:

- [ ] ‚úÖ Tous les tests unitaires passent
- [ ] ‚úÖ Couverture de code > 80%
- [ ] ‚úÖ Aucune API key dans le code source
- [ ] ‚úÖ L'app fonctionne en Debug et Release
- [ ] ‚úÖ Documentation √† jour
- [ ] ‚úÖ Code review effectu√©
- [ ] ‚úÖ Pull Request merg√©e

**F√©licitations! Votre projet est maintenant testable et s√©curis√©! üéâ**

---

*Guide cr√©√© le 15 octobre 2025*
*Compatible avec Swift 6.0 et SwiftUI*
